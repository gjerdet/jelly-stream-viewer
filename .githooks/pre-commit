#!/bin/bash
#
# Pre-commit hook for Jelly Stream Viewer
# Forhindrer at sensitive filer blir committet til Git
#

# Farger for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Sjekk om .env filen er staged
if git diff --cached --name-only | grep -q "^\.env$"; then
  echo -e "${RED}‚ùå ERROR: Fors√∏kte √• committe .env fil!${NC}"
  echo ""
  echo "Denne filen inneholder sensitive API-n√∏kler og skal ALDRI v√¶re i Git."
  echo ""
  echo "L√∏sning:"
  echo "  git reset HEAD .env"
  echo ""
  echo "For √• fjerne .env fra Git-historikken, se GIT_CLEANUP.md"
  exit 1
fi

# Sjekk om .env.local er staged
if git diff --cached --name-only | grep -q "^\.env\.local$"; then
  echo -e "${RED}‚ùå ERROR: Fors√∏kte √• committe .env.local fil!${NC}"
  echo ""
  echo "Denne filen inneholder sensitive data og skal ikke v√¶re i Git."
  echo ""
  echo "L√∏sning:"
  echo "  git reset HEAD .env.local"
  exit 1
fi

# Sjekk om det finnes hardkodede secrets i staged filer
if git diff --cached --diff-filter=AM | grep -E '(SUPABASE_SERVICE_ROLE_KEY|password.*=.*["\']|api[_-]?key.*=.*["\'])' > /dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Mulig hardkodet secret funnet i staged endringer!${NC}"
  echo ""
  echo "Sjekk f√∏lgende linjer:"
  git diff --cached --diff-filter=AM | grep -n -E '(SUPABASE_SERVICE_ROLE_KEY|password.*=.*["\']|api[_-]?key.*=.*["\'])'
  echo ""
  echo -e "${YELLOW}Er du sikker p√• at dette ikke er en secret? (y/N)${NC}"
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "Commit avbrutt. Fjern secrets f√∏r du pr√∏ver igjen."
    exit 1
  fi
fi

# Sjekk at alle *.ts og *.tsx filer f√∏lger linting regler
echo "üîç Kj√∏rer linter p√• staged filer..."
npm run lint --quiet

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå Linting feilet! Fiks feilene f√∏r du committer.${NC}"
  echo ""
  echo "Kj√∏r 'npm run lint' for √• se alle feil."
  echo "Kj√∏r 'npm run lint -- --fix' for √• fikse automatisk."
  exit 1
fi

# Alt OK!
echo -e "‚úÖ Pre-commit sjekker best√•tt!"
exit 0
